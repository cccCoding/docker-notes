## Docker Swarm

### 定义

Docker Swarm 是 Docker 官方推出的容器集群管理和编排工具。

优点：

* 迁移：原生支持 Docker API，原来的 Docker 用户可以很方便地将服务迁移到 Swarm 中来；
* 跨主机通信：内置了对 Docker 网络插件的支持，因此用户可以很方便地部署需要跨主机通信的容器集群；
* 分布式： 使用 Raft（一种分布式一致性协议）协议来做集群间数据一致性保障，使用多个容器节点组成管理集群，从而避免单点故障；
* 安全： 使用 TLS 双向认证来确保节点之间通信的安全，它可以利用双向 TLS 进行节点之间的身份认证，角色授权和加密传输，并且可以自动执行证书的颁发和更换；
* 简单： 操作简单，并且除 Docker 外基本无其他外部依赖，而且从 Docker 1.12 版本后， Swarm 直接被内置到了 Docker 中，可以说真正做到了开箱即用。

### Swarm 的架构

Swarm 的架构整体分为管理节点（Manager Nodes）和工作节点（Worker Nodes），架构图如下：

![image.png](https://s0.lgstatic.com/i/image/M00/67/E1/CgqCHl-iZxSAbYhzAABiA3_fQM8971.png)

**管理节点：**管理节点负责接受用户的请求，用户的请求中包含用户定义的容器运行状态描述，然后 Swarm 负责调度和分发容器管理任务，以达到用户希望的状态。

**工作节点：**工作节点运行执行器（Executor），负责执行具体的容器管理任务（Task），如容器的启动、停止等。

> 管理节点和工作节点的角色并不是一成不变的，可以手动将工作节点转换为管理节点，或将管理节点转换为工作节点。

### 核心概念

#### 集群

Swarm 集群是一组被 Swarm 统一管理和调度的节点，被 Swarm 纳管的节点可以是物理机或者虚拟机。其中一部分节点作为管理节点，负责集群状态的管理和协调，另一部分作为工作节点，负责执行具体的任务来管理容器，实现用户服务的启停等功能。

#### 节点

Swarm 集群中的每一台物理机或者虚拟机称为节点。节点按照工作职责分为管理节点和工作节点。管理节点由于需要使用 Raft 协议来协商节点状态，生产环境中建议将管理节点的数量设置为奇数个，一般为 3 个、5 个或 7 个。

#### 服务

服务是为了支持容器编排所提出的概念，它是一系列复杂容器环境互相协作的统称。一个服务的声明通常包含容器的启动方式、启动的副本数、环境变量、存储、配置、网络等一系列配置，用户通过声明一个服务，将它交给 Swarm，Swarm 负责将用户声明的服务实现。

服务分为全局服务（global services）和副本服务（replicated services）。

* 全局服务：每个工作节点上都会运行一个任务，类似于 Kubernetes 中的 Daemonset。

* 副本服务：按照指定的副本数在整个集群中调度运行。

#### 任务

任务是集群中的最小调度单位，它包含一个真正运行中的 Docker 容器。当管理节点根据服务中声明的副本数将任务调度到工作节点时，任务则开始在该节点启动和运行，当节点出现异常时，任务会运行失败。此时调度器会把失败的任务重新调度到其他正常的节点上正常运行，以确保运行中的容器副本数满足用户所期望的副本数。

#### 服务外部访问

由于容器的 IP 只能在集群内部访问到，而且容器又是用后马上销毁，这样容器的 IP 也会动态变化，因此容器集群内部的服务想要被集群外部的用户访问到，服务必须要映射到主机上的固定端口。Swarm 使用入口负载均衡（ingress load balancing）的模式将服务暴露在主机上，该模式下，每一个服务会被分配一个公开端口（PublishedPort），你可以指定使用某个未被占用的公开端口，也可以让 Swarm 自动分配一个。

Swarm 集群的公开端口可以从集群内的任意节点上访问到，当请求达到集群中的一个节点时，如果该节点没有要请求的服务，则会将请求转发到实际运行该服务的节点上，从而响应用户的请求。

### **集群搭建**

#### 要求

* Docker 版本大于 1.12，推荐使用最新稳定版 Docker；
* 主机需要开放一些端口（TCP：2377 UDP:4789 TCP 和 UDP:7946）。

* 生产环境推荐使用至少三个管理节点

#### 步骤

1. 集群初始化

   在管理节点初始化

   ```shell
   docker swarm init
   ```

2. 加入管理节点

   ```shell
   # 查看加入命令
   docker swarm join-token manager
   # 复制输出结果即可加入管理节点到集群中
   ```

3. 加入工作节点

   按第一步的提示，复制命令，使工作节点加入集群

   ```shell
   docker swarm join --token SWMTKN-1-1kal5b1iozbfmnnhx3kjfd3y6yqcjjjpcftrlg69pm2g8hw5vx-8j4l0t2is9ok9jwwc3tovtxbp 192.168.31.100:2377
   ```

4. 节点查看

   ```shell
   docker node ls
   ```

### 使用

#### **创建服务**

1. **通过 docker service create 命令创建服务**

   ```shell
   docker service create --replicas 1 --name nginx01 nginx
   
   docker service ls
   
   docker service rm nginx01
   ```

   生产环境中，推荐使用 docker-compose 模板文件来部署服务，这样服务的管理会更加方便并且可追踪，而且可以同时创建和管理多个服务，更加适合生产环境中依赖关系较复杂的部署模式。

2. **通过 docker stack 命令创建服务**

   使用 docker-compose 模板文件，添加 deploy 指令

   ```shell
   docker stack deploy -c docker-compose.yml wordpress
   
   docker service ls
   ```

### raft 一致性协议

