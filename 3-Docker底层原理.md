## Docker底层原理

#### docker run 流程

```
docker run hello-world
```

1. 在本机寻找镜像
2. 有则使用这个镜像运行，没有则去 DockerHub 上下载
3. 运行镜像



#### 底层原理

Docker 是一个Client-Server 结构的系统，Docker 的守护进程运行在宿主机上，通过 Socket 从客户端访问。

DockerServer 接收到 Docker-Client的指令，执行命令。

架构图todo

**Docker为什么比VM快**

1. Docker有着比虚拟机更少的抽象层
2. Docker用的是宿主机的内核，VM需要Guest OS，不需要重新加载一个操作系统内核，避免引导。



### 容器技术原理

Docker 是利用 Linux 的 Namespace 、Cgroups 和联合文件系统三大机制来保证实现的， 所以它的原理是使用 Namespace 做主机名、网络、PID 等资源的隔离，使用 Cgroups 对进程或者进程组做资源（例如：CPU、内存等）的限制，联合文件系统用于镜像构建和容器运行环境。

#### chroot

**什么是chroot**

> chroot 是在 Unix 和 Linux 系统的一个操作，针对正在运作的软件进程和它的子进程，改变它外显的根目录。一个运行在这个环境下，经由 chroot 设置根目录的程序，它不能够对这个指定根目录之外的文件进行访问动作，不能读取，也不能更改它的内容。

通俗地讲，chroot 可以把任何目录更改为当前进程的根目录，使这个程序不能访问目录之外的其他目录。

chroot 是最早的容器雏形。

#### Namespace

Namespace 是 Linux 内核的一项功能，该功能对内核资源进行隔离，使容器中的进程都可以在单独的命令空间中运行，并且只可以访问当前容器命名空间的资源。

Docker 主要用到以下五种命名空间。

* pid namespace：用于隔离进程 ID。
* net namespace：用于隔离网络接口，在虚拟的 net namespace 内，用户可以拥有自己独立的 IP、路由、端口等。
* mnt namespace：文件系统挂载点隔离。
* ipc namespace：信号量、消息队列和共享内存的隔离。
* uts namespace：主机名和域名的隔离。

#### Cgroups

Cgroups 是一种 Linux 内核功能，可以限制和隔离进程的资源使用情况（CPU、内存、磁盘I/O、网络等）。在容器的实现中，Cgroups 通常用来限制容器的 CPU 和内存等资源的使用。

#### 联合文件系统

联合文件系统，又叫 UnionFs，是一种通过创建文件层进程操作的文件系统。因此，联合文件系统非常轻快。Docker 使用联合文件系统为容器提供构建层，使得容器可以实现写时复制以及镜像的分层构建和存储。常用的联合文件系统由 AUFS、Overlay 和Devicemapper等。

#### 结语

容器技术从 1979 年 chroot 的首次问世便已崭露头角，但是到了 2013 年，Dokcer 的横空出世才使得容器技术迅速发展。而Docker爆发的原因是，在同类产品的基础上加入了镜像功能，并且封装了镜像仓库使得镜像分发更加方便。

Docker 还提供了工具和平台来管理容器的生命周期：

1. 使用容器开发应用程序及其支持组件。
2. 容器成为分发和测试你的应用程序的单元。
3. 可以将应用程序作为容器或协调服务部署到生产环境中。无论您的生产环境是本地数据中心，云提供商还是两者的混合，其工作原理都相同。